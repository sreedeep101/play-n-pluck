<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Chatbot Web UI</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DOMPurify for HTML sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; /* Hide body overflow */
        }

        /* Main app container */
        .app-container {
            display: flex;
            height: 90vh; /* Make it take most of the viewport height */
            width: 95%;
            max-width: 1200px; /* Max width for the entire app */
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden; /* Important for inner scrolling */
        }

        /* Sidebar */
        .sidebar {
            width: 280px; /* Fixed width for sidebar */
            background-color: #2d3748; /* Darker background for sidebar */
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #4a5568;
            transition: transform 0.3s ease-in-out;
            transform: translateX(0); /* Default visible */
            flex-shrink: 0; /* Prevent shrinking */
        }

        .sidebar.hidden-sidebar {
            transform: translateX(-100%); /* Hide off-screen */
            width: 0; /* Collapse width */
        }

        /* Sidebar Toggle Button (visible when sidebar is hidden) */
        .sidebar-toggle-button {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 100; /* Ensure it's above other elements */
            background-color: #3b82f6;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            display: none; /* Hidden by default, shown by JS */
        }
        .sidebar-toggle-button:hover {
            background-color: #2563eb;
        }

        /* Main Chat Area */
        .main-chat-area {
            flex-grow: 1; /* Takes remaining space */
            display: flex;
            flex-direction: column;
            position: relative; /* For toggle button positioning */
        }

        /* Chat Container inside Main Chat Area */
        .chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Hide direct overflow */
            border-radius: 0; /* Remove outer border-radius */
            box-shadow: none; /* Remove outer shadow */
        }
        
        .chat-history {
            flex-grow: 1;
            overflow-y: auto; /* Enable scrolling for chat history */
            padding: 1rem;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
        }
        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            margin-bottom: 0.75rem;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.5;
        }
        .user-message {
            background-color: #e0f2fe;
            align-self: flex-end;
            margin-left: auto;
        }
        .bot-message {
            background-color: #fce4ec;
            align-self: flex-start;
            margin-right: auto;
        }
        /* Styling for structured elements within bot messages */
        .bot-message h3 {
            font-weight: 600;
            margin-top: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 1.125rem;
            color: #333;
        }
        .bot-message h4 {
            font-weight: 600;
            margin-top: 0.6rem;
            margin-bottom: 0.4rem;
            font-size: 1rem;
            color: #444;
        }
        .bot-message p {
            margin-bottom: 0.5rem;
        }
        .bot-message ul, .bot-message ol {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .bot-message li {
            margin-bottom: 0.25rem;
        }
        .bot-message pre {
            background-color: #e2e8f0;
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .bot-message code {
            background-color: #cbd5e1;
            padding: 0.1rem 0.3rem;
            border-radius: 0.25rem;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.875rem;
        }
        .bot-message strong {
            font-weight: 700;
        }
        .bot-message em {
            font-style: italic;
        }
        /* Style for the inverted message */
        .bot-message .inverted-text {
            font-size: 0.75rem; /* Smaller font */
            color: #718096; /* Lighter color */
            font-style: italic;
            margin-top: 0.5rem; /* Space above */
            padding-top: 0.5rem; /* Padding for visual separation */
            border-top: 1px dashed #a0aec0; /* Dashed line separator */
        }

        .input-area {
            background-color: #ffffff;
            padding: 1rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
        }
        .input-area input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 9999px;
            outline: none;
            transition: border-color 0.2s;
        }
        .input-area input:focus {
            border-color: #3b82f6;
        }
        .input-area button {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            margin-left: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .input-area button:hover {
            background-color: #2563eb;
        }
        .controls-area {
            background-color: #ffffff;
            padding: 0.75rem 1rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .controls-area label {
            color: #4a5568;
        }
        .controls-area select {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e0e0e0;
            background-color: #f9f9f9;
            cursor: pointer;
            outline: none;
            color: #2d3748;
        }
        .controls-area button {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-left: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .controls-area button:hover {
            background-color: #dc2626;
        }

        /* Sidebar specific styles */
        .sidebar-header {
            padding: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            border-bottom: 1px solid #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-header button {
            background-color: #3b82f6;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .sidebar-header button:hover {
            background-color: #2563eb;
        }
        .new-chat-button {
            background-color: #10b981; /* Green for new chat */
            margin: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: center;
        }
        .new-chat-button:hover {
            background-color: #059669;
        }
        .conversation-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0.5rem 1rem;
        }
        .conversation-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background-color: #4a5568; /* Darker gray for list items */
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Add ellipsis for long titles */
        }
        .conversation-item:hover {
            background-color: #606f7b;
        }
        .conversation-item.active {
            background-color: #3b82f6; /* Active conversation highlight */
            font-weight: 600;
        }

        /* Responsive adjustments for sidebar */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
                height: 100vh; /* Full height on small screens */
                width: 100%;
                border-radius: 0;
            }
            .sidebar {
                position: absolute;
                height: 100%;
                width: 80%; /* Takes 80% width on small screens */
                z-index: 50; /* Ensure sidebar is on top */
                transform: translateX(-100%); /* Hidden by default on small screens */
            }
            .sidebar.show-sidebar {
                transform: translateX(0); /* Show sidebar */
            }
            .main-chat-area {
                width: 100%;
                margin-left: 0;
            }
            .sidebar-toggle-button {
                display: block; /* Show toggle button on small screens */
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="app-container">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <span>Chats</span>
                <button id="hide-sidebar-button" class="md:hidden">×</button> <!-- Hide button for small screens -->
            </div>
            <button id="new-chat-button" class="new-chat-button">
                + New Chat
            </button>
            <div id="conversation-list" class="conversation-list">
                <!-- Conversation items will be dynamically loaded here -->
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-chat-area">
            <button id="show-sidebar-button" class="sidebar-toggle-button md:hidden">☰</button> <!-- Show button for small screens -->
            <div class="chat-container">
                <!-- Chat History -->
                <div id="chat-history" class="chat-history flex flex-col">
                    <!-- Initial welcome message -->
                </div>

                <!-- Input Area -->
                <div class="input-area">
                    <input type="text" id="user-input" placeholder="Type your message..." class="focus:ring-2 focus:ring-blue-500">
                    <button id="send-button">Send</button>
                </div>

                <!-- Controls Area -->
                <div class="controls-area">
                    <label for="speech-rate-select" class="mr-2 text-gray-700">Speech Rate:</label>
                    <select id="speech-rate-select">
                        <option value="normal">Normal</option>
                        <option value="slow">Slow</option>
                        <option value="fast">Fast</option>
                    </select>
                    <button id="exit-button">Exit</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const sidebar = document.getElementById('sidebar');
        const showSidebarButton = document.getElementById('show-sidebar-button');
        const hideSidebarButton = document.getElementById('hide-sidebar-button');
        const newChatButton = document.getElementById('new-chat-button');
        const conversationList = document.getElementById('conversation-list');
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const speechRateSelect = document.getElementById('speech-rate-select');
        const exitButton = document.getElementById('exit-button');

        // Web Speech API for text-to-speech
        const synth = window.speechSynthesis;
        let currentVoice = null; 

        // Global variables for conversation management
        let allConversations = []; // Array to store all conversation objects
        let currentConversationId = null; // ID of the currently active conversation

        // --- Utility Functions ---

        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function saveConversations() {
            localStorage.setItem('allConversations', JSON.stringify(allConversations));
        }

        function loadConversations() {
            const storedConversations = localStorage.getItem('allConversations');
            if (storedConversations) {
                allConversations = JSON.parse(storedConversations);
            } else {
                allConversations = [];
            }
        }

        function getConversationById(id) {
            return allConversations.find(conv => conv.id === id);
        }

        function getCurrentConversation() {
            if (!currentConversationId) return null;
            return getConversationById(currentConversationId);
        }

        function setSpeechRate(rateOption) {
            let rate = 1.0;
            switch (rateOption) {
                case 'slow': rate = 0.7; break;
                case 'fast': rate = 1.3; break;
                case 'normal': default: rate = 1.0; break;
            }
            return rate;
        }

        function speakText(text, rateOption = 'normal') {
            if (synth.speaking) {
                synth.cancel();
            }
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = setSpeechRate(rateOption);

            if (!currentVoice && synth.getVoices().length > 0) {
                const voices = synth.getVoices();
                currentVoice = voices.find(voice => voice.lang === 'en-US' || voice.lang.startsWith('en')) || voices[0];
            }
            utterance.voice = currentVoice;

            utterance.onerror = (event) => {
                console.error('SpeechSynthesisUtterance.onerror', event);
            };
            synth.speak(utterance);
        }

        synth.onvoiceschanged = () => {
            currentVoice = null;
        };

        // --- UI Rendering Functions ---

        function clearChatHistoryDisplay() {
            chatHistory.innerHTML = '';
        }

        // Modified appendMessage to add to current conversation data and display
        // Now also accepts an optional invertedMessage for display
        function appendMessage(sender, messageContent, isBot = false, invertedMessage = null, conversationId = currentConversationId) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message-bubble');
            
            if (isBot) {
                messageDiv.classList.add('bot-message');
                if (typeof messageContent === 'object' && messageContent !== null) {
                    // Render structured content
                    const mainContentDiv = document.createElement('div'); // Use a main content div for structured output
                    if (messageContent.title) {
                        const titleElement = document.createElement('h3');
                        titleElement.innerHTML = DOMPurify.sanitize(marked.parseInline(String(messageContent.title || ''))); 
                        mainContentDiv.appendChild(titleElement);
                    }
                    if (messageContent.sections) {
                        messageContent.sections.forEach(section => {
                            if (section.heading) {
                                const headingElement = document.createElement('h4');
                                headingElement.innerHTML = DOMPurify.sanitize(marked.parseInline(String(section.heading || ''))); 
                                mainContentDiv.appendChild(headingElement);
                            }
                            if (section.content) {
                                section.content.forEach(item => {
                                    let element;
                                    let itemParsedContent = '';
                                    switch (item.type) {
                                        case 'paragraph':
                                            itemParsedContent = marked.parseInline(String(item.value || ''));
                                            element = document.createElement('p');
                                            element.innerHTML = DOMPurify.sanitize(itemParsedContent);
                                            break;
                                        case 'list':
                                            element = document.createElement('ul');
                                            (String(item.value || '')).split('\n').forEach(listItemText => {
                                                if (listItemText.trim()) {
                                                    const li = document.createElement('li');
                                                    li.innerHTML = DOMPurify.sanitize(marked.parseInline(String(listItemText.trim())));
                                                    element.appendChild(li);
                                                }
                                            });
                                            break;
                                        case 'code':
                                            element = document.createElement('pre');
                                            const codeElement = document.createElement('code');
                                            codeElement.textContent = item.value || ''; 
                                            element.appendChild(codeElement);
                                            break;
                                        default:
                                            itemParsedContent = marked.parseInline(String(item.value || ''));
                                            element = document.createElement('p');
                                            element.innerHTML = DOMPurify.sanitize(parsedContent);
                                    }
                                    if (element) {
                                        mainContentDiv.appendChild(element);
                                    }
                                });
                            }
                        });
                    }
                    messageDiv.appendChild(mainContentDiv); // Append the structured content

                    // Add inverted text if provided
                    if (invertedMessage) {
                        const invertedDiv = document.createElement('div');
                        invertedDiv.classList.add('inverted-text');
                        invertedDiv.textContent = 'Inverted: ' + invertedMessage;
                        messageDiv.appendChild(invertedDiv);
                    }

                } else {
                    // Fallback for non-structured bot messages (e.g., error strings)
                    const fallbackContentDiv = document.createElement('div');
                    fallbackContentDiv.innerHTML = DOMPurify.sanitize(marked.parse(String(messageContent || ''))); 
                    messageDiv.appendChild(fallbackContentDiv);

                     // Add inverted text even for fallback if provided
                    if (invertedMessage) {
                        const invertedDiv = document.createElement('div');
                        invertedDiv.classList.add('inverted-text');
                        invertedDiv.textContent = 'Inverted: ' + invertedMessage;
                        messageDiv.appendChild(invertedDiv);
                    }
                }
            } else {
                messageDiv.classList.add('user-message');
                messageDiv.textContent = messageContent;
            }
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // Save to current conversation in localStorage
            const conversation = getConversationById(conversationId);
            if (conversation) {
                conversation.messages.push({
                    sender: sender,
                    content: messageContent, // Store original structured content if bot, or plain text if user
                    isBot: isBot,
                    inverted: invertedMessage, // Store inverted message
                    timestamp: new Date().toISOString()
                });
                // Update conversation title if it's the first user message
                if (sender === 'You' && conversation.messages.length === 2) { 
                    conversation.title = String(messageContent).split(' ').slice(0, 5).join(' ') + '...'; 
                    renderSidebarHistory(); 
                }
                saveConversations();
            }
        }
        
        // This function needs to match the backend's flatten_structured_response
        function flattenStructuredResponseForSpeech(structured_data) {
            let flat_text = [];
            if (structured_data && structured_data.title) {
                flat_text.push(structured_data.title);
            }
            if (structured_data && structured_data.sections) {
                structured_data.sections.forEach(section => {
                    if (section.heading) {
                        flat_text.push(section.heading);
                    }
                    if (section.content) {
                        section.content.forEach(item => {
                            if (item.value) {
                                flat_text.push(item.value);
                            }
                        });
                    }
                });
            }
            return flat_text.join(" ");
        }

        // Renders all conversation titles in the sidebar
        function renderSidebarHistory() {
            conversationList.innerHTML = ''; // Clear existing list
            allConversations.forEach(conv => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('conversation-item', 'truncate'); 
                if (conv.id === currentConversationId) {
                    itemDiv.classList.add('active');
                }
                itemDiv.dataset.conversationId = conv.id;
                itemDiv.textContent = conv.title || "New Chat"; 
                itemDiv.addEventListener('click', () => switchConversation(conv.id));
                conversationList.appendChild(itemDiv);
            });
        }

        // Switches to a different conversation
        function switchConversation(id) {
            if (currentConversationId === id) return; 

            currentConversationId = id;
            clearChatHistoryDisplay(); 

            const conversation = getConversationById(id);
            if (conversation) {
                conversation.messages.forEach(msg => {
                    // Pass inverted message when loading history
                    appendMessage(msg.sender, msg.content, msg.isBot, msg.inverted, id); 
                });
            }
            renderSidebarHistory(); 
            hideSidebar(); 
        }

        // Starts a new conversation
        function startNewConversation() {
            const newConversation = {
                id: generateUniqueId(),
                title: "New Chat",
                messages: []
            };
            allConversations.unshift(newConversation); 
            saveConversations();
            switchConversation(newConversation.id); 
            appendMessage('Bot', {
                sections: [
                    { content: [{ type: 'paragraph', value: 'Hello! How can I help you today?' }] }
                ]
            }, true); // Initial message for new chat
            userInput.focus(); 
        }

        // --- Event Handlers ---

        async function sendMessage() {
            const userMessage = userInput.value.trim();
            if (!userMessage) return;

            appendMessage('You', userMessage);
            userInput.value = '';

            // Show a loading indicator
            appendMessage('Bot', '...', true); 

            try {
                const response = await fetch('http://127.0.0.1:5000/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_input: userMessage }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Remove loading indicator
                const loadingBubble = chatHistory.querySelector('.bot-message:last-child');
                if (loadingBubble && loadingBubble.textContent === '...') {
                    chatHistory.removeChild(loadingBubble);
                }

                // Append the AI's structured reply AND the inverted reply to the display and current conversation data
                appendMessage('Bot', data.structured_reply, true, data.inverted_reply); 
                speakText(data.original_reply, speechRateSelect.value); 
            } catch (error) {
                console.error('Error:', error);
                // Remove loading indicator and show error message
                const loadingBubble = chatHistory.querySelector('.bot-message:last-child');
                if (loadingBubble && loadingBubble.textContent === '...') {
                    chatHistory.removeChild(loadingBubble);
                }
                appendMessage('Bot', 'Error: Could not get a reply. Please ensure the Python backend is running and accessible.', true, 'No inverted reply due to error.');
                speakText('Sorry, I am having trouble connecting.', 'normal');
            }
        }

        // Sidebar toggle logic for smaller screens
        function toggleSidebar() {
            sidebar.classList.toggle('show-sidebar');
            showSidebarButton.style.display = sidebar.classList.contains('show-sidebar') ? 'none' : 'block';
        }

        function hideSidebar() {
            if (window.innerWidth <= 768) { 
                sidebar.classList.remove('show-sidebar');
                showSidebarButton.style.display = 'block';
            }
        }
        
        // --- Initialization ---

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
        speechRateSelect.addEventListener('change', (event) => {
            appendMessage('System', { sections: [{ content: [{ type: 'paragraph', value: `Speech rate set to: **${event.target.value}**.` }] }] }, true); 
        });
        exitButton.addEventListener('click', () => {
            alert("Chatbot session ended. You can close this tab/window.");
            window.close(); 
        });

        newChatButton.addEventListener('click', startNewConversation);
        showSidebarButton.addEventListener('click', toggleSidebar);
        hideSidebarButton.addEventListener('click', hideSidebar);

        // On page load
        loadConversations();
        if (allConversations.length > 0) {
            // Load the most recent conversation
            switchConversation(allConversations[0].id);
            renderSidebarHistory(); 
        } else {
            // Start a brand new conversation if no history exists
            startNewConversation();
        }

        // Adjust sidebar visibility based on screen size on load
        if (window.innerWidth <= 768) {
            sidebar.classList.add('hidden-sidebar'); 
            showSidebarButton.style.display = 'block';
        } else {
            sidebar.classList.remove('hidden-sidebar'); 
            showSidebarButton.style.display = 'none';
        }
    </script>
</body>
</html>
